<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; padding-bottom: 70px; }
    .container { max-width: 98%; margin: 0 auto; background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; }
    h2 { color: #0056b3; text-align: center; margin-bottom: 5px; }
    h3.subtitle { color: #0056b3; text-align: center; margin-top: 0; margin-bottom: 25px; font-size: 1.1em; font-weight: normal; }
    .form-group { margin-bottom: 15px; }
    .radio-group { padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #fcfcfc; }
    .radio-option { display: flex; align-items: center; margin-bottom: 12px; cursor: pointer; }
    .radio-option input[type="radio"] { margin-right: 10px; flex-shrink: 0; }
    .radio-option label { line-height: 1.4; font-weight: normal; cursor: pointer; }
    .form-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .form-group-header label { margin-bottom: 0; font-weight: bold; color: #555; }
    #tipoEventoDescripcion { padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; background-color: #f0f0f0; font-size: 0.9em; color: #666; min-height: 120px; text-align: left; white-space: pre-wrap; box-sizing: border-box; }
    select, input[type="text"] { width: 100%; padding: 10px; border: 1.5px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; background-color: #fff; }
    .campo-invalido { border-color: #e74c3c !important; animation: shake 0.5s; }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
    #presupuestoDetalle { margin-top: 25px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px; background-color: #f9f9f9; }
    #presupuestoDetalle ul { list-style: none; padding: 0; margin: 0 0 15px 0; text-align: left; }
    #presupuestoDetalle ul li { margin-bottom: 5px; font-size: 1.05em; color: #444; }
    #presupuestoTotal { text-align: right; font-size: 1.8em; font-weight: bold; color: #28a745; margin-top: 15px; border-top: 2px solid #ddd; padding-top: 10px; }
    #presupuestoTotal span { font-size: 0.7em; color: #555; }
    .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 10; border-radius: 8px; flex-direction: column; display: none; }
    .loading-overlay p { font-size: 1.2em; font-weight: bold; color: #0056b3; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-top: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #notification-banner { position: fixed; bottom: 20px; left: 50%; transform: translate(-50%, 150%); padding: 12px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); color: white; font-size: 16px; font-weight: 500; z-index: 1000; transition: transform 0.5s ease-in-out; max-width: 90%; text-align: center; }
    #notification-banner.show { transform: translate(-50%, 0); }
    #notification-banner.warning { background-color: #ffc107; color: #333; }
    #notification-banner.error { background-color: #dc3545; }
    .column-layout { display: flex; flex-direction: column; gap: 0; }
    .button-group { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
    button { flex: 1; background-color: #007bff; color: white; padding: 15px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 18px; font-weight: bold; }
    button:hover { background-color: #0056b3; }
    @media (min-width: 768px) { .column-layout { flex-direction: row; gap: 15px; } .column-layout .form-group { flex: 1; } .button-group { flex-direction: row; gap: 10px; } button { font-size: 16px; padding: 12px 20px; } }
    textarea {
        width: 100%; padding: 10px; border: 1.5px solid #ccc;
        border-radius: 4px; box-sizing: border-box; font-size: 16px;
        font-family: Arial, sans-serif; resize: vertical;
      }
  </style>
</head>
<body>
  <div class="container" id="mainContainer">
    <h2>Editor de Solicitud de Evento</h2>
    <h3 class="subtitle">Modifique los detalles y guarde los cambios</h3>
    <form id="navigationForm" style="display:none;"></form>
    <input type="hidden" id="precioBase" name="precioBase">
    <fieldset id="edit-fieldset">
      <div class="column-layout">
        <div class="form-group" id="tipoEventoGroup"><div class="form-group-header"><label>Tipo de Evento:</label></div><div id="tipoEventoContainer" class="radio-group"></div></div>
        <div class="form-group" id="descripcionGroup"><label>Descripción:</label><div id="tipoEventoDescripcion">Seleccione un tipo de evento.</div></div>
      </div>
      <div class="column-layout">
          <div class="form-group"><label for="fechaEvento">Fecha del Evento:</label><input type="text" id="fechaEvento" placeholder="Seleccione una fecha..."></div>
          <div class="form-group" id="horaInicioGroup"><label for="horaInicio">Hora de Inicio:</label><select id="horaInicio"><option value="">--</option></select></div>
      </div>
      <div class="column-layout">
          <div class="form-group" id="cantidadPersonasGroup"><label for="cantidadPersonas">Cantidad de Personas:</label><select id="cantidadPersonas"><option value="">--</option></select></div>
          <div class="form-group" id="duracionEventoGroup"><label for="duracionEvento">Duración del Evento:</label><select id="duracionEvento"><option value="">--</option></select></div>
      </div>
      <div class="form-group">
        <label for="detallesAdicionales">Detalles Adicionales (opcional):</label>
        <textarea id="detallesAdicionales" name="detallesAdicionales" rows="4" placeholder="Alergias, pedidos especiales, decoración, etc."></textarea>
      </div>
    </fieldset>
    <hr>
    <h3>Resumen de Presupuesto Básico:</h3>
    <div id="presupuestoDetalle"><p>Cargando datos...</p></div>
    <div id="presupuestoTotal"><span>Total Básico: </span> $0</div>
    <div class="button-group" id="button-container">
      <button id="cancel-button" onclick="window.top.location.href='<?= urlDeLaApp ?>?page=admin'" style="background-color: #6c757d;">Cancelar</button>
      <button id="save-button" onclick="guardarCambios()">Guardar Cambios</button>
    </div>
    <div class="loading-overlay" id="loadingOverlay" style="display: flex;"><p>Cargando datos de la solicitud...</p><div class="spinner"></div></div>
  </div>
  <div id="notification-banner"></div>

<script>
    const App = {
        solicitudId: <?= solicitudId ?>,
        tarifas: [], tiposDeEvento: [], opcionesCantidades: {}, opcionesDuraciones: {},
        opcionesHoras: {}, descripcionesTipos: {}, calendario: null, feriadosGlobal: [],
        notificationTimer: null,
        elements: {},

        init: function() {
            this.elements.tipoEventoContainer = document.getElementById('tipoEventoContainer');
            this.elements.cantidadPersonasSelect = document.getElementById('cantidadPersonas');
            this.elements.duracionEventoSelect = document.getElementById('duracionEvento');
            this.elements.horaInicioSelect = document.getElementById('horaInicio');
            this.elements.fechaEventoInput = document.getElementById('fechaEvento');
            this.elements.presupuestoDetalleDiv = document.getElementById('presupuestoDetalle');
            this.elements.presupuestoTotalDiv = document.getElementById('presupuestoTotal');
            this.elements.loadingOverlay = document.getElementById('loadingOverlay');
            this.elements.precioBaseInput = document.getElementById('precioBase');
            this.elements.notificationBanner = document.getElementById('notification-banner');
            this.elements.saveButton = document.getElementById('save-button');
            this.elements.cancelButton = document.getElementById('cancel-button');
            this.elements.buttonContainer = document.getElementById('button-container');
            this.elements.editFieldset = document.getElementById('edit-fieldset');
            this.elements.tipoEventoDescripcionDiv = document.getElementById('tipoEventoDescripcion');
            this.elements.detallesAdicionalesTextarea = document.getElementById('detallesAdicionales');

            [this.elements.cantidadPersonasSelect, this.elements.duracionEventoSelect, this.elements.horaInicioSelect].forEach(el => {
                if (el) el.addEventListener('change', () => this.actualizarDetallePresupuesto());
            });

            window.guardarCambios = () => this.guardarCambios();
            this.cargarDatosParaEdicion();
        },

        cargarDatosParaEdicion: function() {
            google.script.run
                .withSuccessHandler(data => {
                    if (data.error) {
                        this.showNotification(data.error, 'error'); this.toggleLoadingOverlay(false); return;
                    }
                    this.cargarOpcionesIniciales(data.allOptions, () => {
                        this.populateForm(data.solicitud);
                        this.toggleLoadingOverlay(false);
                    });
                })
                .withFailureHandler(error => {
                    this.showNotification(error.message, 'error'); this.toggleLoadingOverlay(false);
                })
                .getSolicitudDataForEdit(this.solicitudId);
        },

        cargarOpcionesIniciales: function(response, callback) {
            this.tarifas = response.tarifas; this.tiposDeEvento = response.tipos;
            this.opcionesCantidades = response.cantidades; this.opcionesDuraciones = response.duraciones;
            this.opcionesHoras = response.horas; this.feriadosGlobal = response.feriados;
            this.descripcionesTipos = {};
            this.tiposDeEvento.forEach(tipo => { this.descripcionesTipos[tipo.id] = tipo.descripcion; });

            this.llenarRadioButtons(this.elements.tipoEventoContainer, 'tipoEvento', this.tiposDeEvento);
            this.elements.tipoEventoContainer.querySelectorAll('input[name="tipoEvento"]').forEach(radio => radio.addEventListener('change', () => this.actualizarOpcionesDependientes()));
            
            const todasLasCantidades = [...new Set(Object.values(this.opcionesCantidades).flat())];
            const todasLasDuraciones = [...new Set(Object.values(this.opcionesDuraciones).flat())];
            const todasLasHoras = [...new Set(Object.values(this.opcionesHoras).flat().map(h => h.hora))].sort();

            this.llenarSelect(this.elements.cantidadPersonasSelect, todasLasCantidades, 'Seleccione cantidad...');
            this.llenarSelect(this.elements.duracionEventoSelect, todasLasDuraciones, 'Seleccione duración...');
            this.llenarSelect(this.elements.horaInicioSelect, todasLasHoras, 'Seleccione hora...');
            
            this.inicializarCalendario(response.fechasOcupadas, this.feriadosGlobal);
            if (callback) callback();
        },
        
        populateForm: function(solicitud) {
            console.log("Datos recibidos para rellenar el formulario:", solicitud);
            const radio = document.querySelector(`input[name="tipoEvento"][value="${solicitud.tipoEvento}"]`);
            if (radio) radio.checked = true;
            this.elements.tipoEventoDescripcionDiv.innerHTML = this.descripcionesTipos[solicitud.tipoEvento] || 'Sin descripción.';

            setTimeout(() => {
                console.log("Dentro del setTimeout: estableciendo valores.");
                this.elements.cantidadPersonasSelect.value = solicitud.cantidadPersonas;
                this.elements.duracionEventoSelect.value = solicitud.duracionEvento;
                this.elements.horaInicioSelect.value = solicitud.horaInicio;
                this.elements.detallesAdicionalesTextarea.value = solicitud.detallesAdicionales || '';

                if (solicitud.fechaEvento && this.calendario) {
                    console.log("Intentando establecer la fecha en el calendario:", solicitud.fechaEvento);
                    this.calendario.setDate(solicitud.fechaEvento, true);
                    
                    // --- ¡CAMBIO CLAVE! ---
                    // Forzamos al calendario a redibujarse. Esto soluciona el bug de renderizado.
                    this.calendario.redraw();
                    
                } else {
                    this.actualizarDetallePresupuesto();
                }
            }, 150); // Aumentamos ligeramente la demora por si acaso
        },


        guardarCambios: function() {
            if (!confirm("¿Estás seguro de que quieres guardar los cambios?")) return;
            this.elements.saveButton.disabled = true;
            this.elements.saveButton.textContent = 'Guardando...';
            this.showNotification('Guardando cambios...', 'info');
            const formData = {
                solicitudId: this.solicitudId,
                tipoEvento: document.querySelector('input[name="tipoEvento"]:checked')?.value || '',
                cantidadPersonas: this.elements.cantidadPersonasSelect.value,
                duracionEvento: this.elements.duracionEventoSelect.value,
                fechaEvento: this.elements.fechaEventoInput.value,
                horaInicio: this.elements.horaInicioSelect.value,
                precioBase: this.elements.precioBaseInput.value,
                detallesAdicionales: this.elements.detallesAdicionalesTextarea.value,
            };
            google.script.run
                .withSuccessHandler(response => {
                    if (response.success) {
                        this.showNotification(response.message, 'success');
                        this.elements.editFieldset.disabled = true;
                        this.elements.cancelButton.remove();
                        this.elements.saveButton.remove();
                        const backButton = document.createElement('button');
                        backButton.textContent = 'Volver al Panel';
                        backButton.style.backgroundColor = '#28a745';
                        backButton.style.width = '100%';
                        backButton.onclick = () => window.top.location.href = '<?= urlDeLaApp ?>?page=admin';
                        this.elements.buttonContainer.appendChild(backButton);
                    } else {
                        this.showNotification(response.message, 'error');
                        this.elements.saveButton.disabled = false;
                        this.elements.saveButton.textContent = 'Guardar Cambios';
                    }
                })
                .withFailureHandler(error => {
                    this.showNotification(error.message, 'error');
                    this.elements.saveButton.disabled = false;
                    this.elements.saveButton.textContent = 'Guardar Cambios';
                })
                .updateSolicitudData(formData);
        },

        showNotification: function(message, type = 'warning', duration = 4000) {
            clearTimeout(this.notificationTimer);
            this.elements.notificationBanner.textContent = message;
            this.elements.notificationBanner.className = 'show ' + type;
            this.notificationTimer = setTimeout(() => { this.elements.notificationBanner.className = ''; }, duration);
        },

        toggleLoadingOverlay: function(show, message = 'Cargando...') {
            this.elements.loadingOverlay.querySelector('p').textContent = message;
            this.elements.loadingOverlay.style.display = show ? 'flex' : 'none';
        },
        
        inicializarCalendario: function(fechasOcupadas, feriados) {
            this.calendario = flatpickr(this.elements.fechaEventoInput, {
                locale: "es", altInput: true, altFormat: "j \\de F, Y", dateFormat: "Y-m-d",
                "disable": fechasOcupadas,
                onChange: () => this.actualizarDetallePresupuesto()
            });
        },
        
        llenarSelect: function(select, options, placeholder) {
            select.innerHTML = `<option value="">${placeholder}</option>`;
            if (options && options.length > 0) {
                options.forEach(opt => { select.innerHTML += `<option value="${opt}">${opt}</option>`; });
                select.disabled = false;
            } else {
                select.disabled = true;
            }
        },

        llenarRadioButtons: function(container, name, options) {
            container.innerHTML = ''; if (!options || options.length === 0) return;
            options.forEach(opt => {
                const id = `radio_${opt.id.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase()}`;
                container.innerHTML += `<div class="radio-option"><input type="radio" id="${id}" name="${name}" value="${opt.id}"><label for="${id}">${opt.nombreParaMostrar}</label></div>`;
            });
        },
        
        actualizarOpcionesDependientes: function() {
            const selectedRadio = document.querySelector('input[name="tipoEvento"]:checked');
            const tipoId = selectedRadio ? selectedRadio.value : '';
            this.elements.tipoEventoDescripcionDiv.innerHTML = tipoId ? this.descripcionesTipos[tipoId] || 'Sin descripción.' : 'Seleccione un tipo de evento.';
            this.actualizarDetallePresupuesto();
        },
        
        actualizarDetallePresupuesto: function() {
            const selectedRadio = document.querySelector('input[name="tipoEvento"]:checked');
            const tipoId = selectedRadio ? selectedRadio.value : '';
            const cantidad = this.elements.cantidadPersonasSelect.value;
            const duracion = this.elements.duracionEventoSelect.value;
            const hora = this.elements.horaInicioSelect.value;
            const fechaStr = this.elements.fechaEventoInput.value;
            const tipoSeleccionado = this.tiposDeEvento.find(t => t.id === tipoId);
            const nombreParaMostrar = tipoSeleccionado ? tipoSeleccionado.nombreParaMostrar : '';
            const montoSena = tipoSeleccionado ? tipoSeleccionado.montoSena : 0;
            const depositoGarantia = tipoSeleccionado ? tipoSeleccionado.depositoGarantia : 0;
            let horaFinStr = '';
            const duracionMatch = duracion.match(/\d+/);
            const duracionNum = duracionMatch ? parseInt(duracionMatch[0]) : 0;
            if (hora && duracionNum > 0) {
                const horaParts = hora.split(':'); const startHour = parseInt(horaParts[0]); const startMinute = parseInt(horaParts[1] || '0');
                if (!isNaN(startHour) && !isNaN(startMinute)) {
                    const fechaCalculo = new Date(); fechaCalculo.setHours(startHour, startMinute, 0, 0);
                    fechaCalculo.setHours(fechaCalculo.getHours() + duracionNum);
                    const endHour = fechaCalculo.getHours(); const endMinute = String(fechaCalculo.getMinutes()).padStart(2, '0');
                    horaFinStr = `${endHour}:${endMinute}`;
                }
            }
            let detalleHtml = '<ul>';
            if (nombreParaMostrar) detalleHtml += `<li><strong>Tipo de Evento:</strong> ${nombreParaMostrar}</li>`;
            if (fechaStr && this.calendario && this.calendario.selectedDates[0]) detalleHtml += `<li><strong>Fecha:</strong> ${this.calendario.selectedDates[0].toLocaleDateString('es-AR')}</li>`;
            if (hora) detalleHtml += `<li><strong>Hora de Inicio:</strong> ${hora}</li>`;
            if (duracion) detalleHtml += `<li><strong>Duración:</strong> ${duracion}</li>`;
            if (horaFinStr) detalleHtml += `<li><strong>Hora de Finalización:</strong> ${horaFinStr} hs.</li>`;
            if (cantidad) detalleHtml += `<li><strong>Cantidad de Personas:</strong> ${cantidad}</li>`;
            if (montoSena > 0) detalleHtml += `<li style="margin-top:10px; color: #0056b3;"><strong>Seña:</strong> $${montoSena.toLocaleString('es-AR')}</li>`;
            if (depositoGarantia > 0) detalleHtml += `<li style="color: #555;"><strong>Depósito:</strong> $${depositoGarantia.toLocaleString('es-AR')} (reintegrable)</li>`;
            detalleHtml += '</ul>';

            if (!tipoId || !cantidad || !duracion || !fechaStr) {
                this.elements.presupuestoDetalleDiv.innerHTML = '<p>Complete las opciones para ver el precio.</p>';
                this.elements.presupuestoTotalDiv.innerHTML = `<span>Total Básico: </span> $0`;
                this.elements.precioBaseInput.value = 0; return;
            }
            const cantidadNum = parseInt(cantidad.match(/\d+/g).pop());
            const fechaSeleccionada = new Date(fechaStr + 'T00:00:00');
            const reglasAplicables = this.tarifas.filter(regla => {
                const fechaVigencia = new Date(regla.fechaVigencia + 'T00:00:00');
                return regla.tipo.toUpperCase() === tipoId.toUpperCase() && cantidadNum >= regla.min && cantidadNum <= regla.max && fechaSeleccionada >= fechaVigencia;
            });
            if (reglasAplicables.length > 0) {
                reglasAplicables.sort((a, b) => new Date(b.fechaVigencia) - new Date(a.fechaVigencia));
                const reglaFinal = reglasAplicables[0];
                const precioCalculado = reglaFinal.precioPorHora * duracionNum;
                this.elements.presupuestoDetalleDiv.innerHTML = detalleHtml;
                this.elements.presupuestoTotalDiv.innerHTML = `<span>Total Básico: </span> $${precioCalculado.toLocaleString('es-AR')}`;
                this.elements.precioBaseInput.value = precioCalculado;
            } else {
                this.elements.presupuestoDetalleDiv.innerHTML = detalleHtml;
                this.elements.presupuestoDetalleDiv.insertAdjacentHTML('beforeend', '<p style="color:red;">No se encontró tarifa.</p>');
                this.elements.presupuestoTotalDiv.innerHTML = `<span>Total Básico: </span> $ -`;
                this.elements.precioBaseInput.value = 0;
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>